// Prisma Client 생성기 설정
generator client {
  provider = "prisma-client-js"
}

// 데이터베이스 연결 설정 (PostgreSQL 사용)
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ----------------------------------------------------------------------
// --- 인증 및 사용자 관련 모델 (Authentication & User) ---
// ----------------------------------------------------------------------

// 사용자 기본 정보
model User {
  id             String    @id @default(cuid())
  name           String
  email          String?   @unique // 이메일은 고유해야 함
  hashedPassword String    @db.VarChar // 해시된 비밀번호
  emailVerified  DateTime?
  image          String?
  role           Role?     @default(USER) // 사용자 권한

  account  Account[] // 계정 연결 정보 (NextAuth)
  sessions Session[] // 세션 정보
  profile  Profile? // 프로필 상세 정보
}

// 사용자 계정 정보 (NextAuth.js 사용)
model Account {
  id                String  @id @default(cuid())
  userId            String  @unique // 사용자 ID에 대한 고유성 제약조건
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? // 리프레시 토큰
  access_token      String? // 액세스 토큰
  expires_at        Int? // 토큰 만료 시간
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  subscribed        Boolean @default(false) // 구독 여부

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId]) // provider와 providerAccountId의 복합 유니크 키
}

// 사용자 세션 정보
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// 사용자 프로필 상세 정보
model Profile {
  id                String   @id @default(cuid())
  userId            String   @unique
  image_url         String?  @db.VarChar // 프로필 이미지 URL
  company           String?  @db.VarChar // 회사
  branch            String?  @db.VarChar // 지점
  department        String?  @db.VarChar // 부서
  title             String?  @db.VarChar // 직책
  use_profile_image Boolean  @default(false) // 프로필 이미지 사용 여부
  created_at        DateTime @default(now()) @db.Timestamp(6)
  updated_at        DateTime @default(now()) @db.Timestamp(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// 이메일 인증 토큰
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// 사용자 권한 ENUM
enum Role {
  USER // 일반 사용자
  ADMIN // 관리자
  DEVELOPER // 개발자
}

// ----------------------------------------------------------------------
// --- 자산 일반 정보 모델 (Property General Info) ---
// ----------------------------------------------------------------------

// 자산 기본 정보
model Property {
  id           String  @id @default(cuid())
  name         String // 자산 이름
  sector_id    String // 섹터 ID (필수)
  subsector_id String? // 서브섹터 ID (선택)

  sector    Sector?    @relation(fields: [sector_id], references: [id], onDelete: Cascade)
  subsector SubSector? @relation(fields: [subsector_id], references: [id], onDelete: Cascade)

  location      Location? // 위치 정보 (1:1)
  scale         Scale? // 규모 정보 (1:1)
  facility      Facility? // 시설 정보 (1:1)
  accessibility Accessibility? // 접근성 정보 (1:1)
  profitability Profitability? // 수익성 정보 (1:1)
  warehouse     Warehouse[] // 창고 온도 비율 정보 (1:N)

  history              History[] // 자산 이력 (1:N)
  propertyImageFile    PropertyImageFile[] // 자산 이미지 파일 (1:N)
  propertyBrochureFile PropertyBrochureFile[] // 자산 브로슈어 파일 (1:N)
  floor                Floor[] // 층 정보 (1:N)
  floorPlanFile        FloorPlanFile[] // 층별 평면도 파일 (1:N)
  transaction          Transaction[] // 거래 정보 (1:N)

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)
}

// 섹터 (주요 분류)
model Sector {
  id   String @id @default(cuid())
  name String // 섹터 이름

  subsector SubSector[]
  Property  Property[]
}

// 서브섹터 (하위 분류)
model SubSector {
  id        String @id @default(cuid())
  sector_id String
  name      String // 서브섹터 이름

  sector Sector @relation(fields: [sector_id], references: [id], onDelete: Cascade)

  Property Property[]
}

// ----------------------------------------------------------------------
// --- 자산 상세 정보 모델 (Property Detailed Info) ---
// ----------------------------------------------------------------------

// 위치 정보
model Location {
  id                 String  @id @default(cuid())
  property_id        String  @unique // 자산 ID (1:1 관계)
  address_full       String? // 전체 주소
  address_full_jibun String? // 지번 주소
  address_province   String? // 광역 시/도
  address_city       String? // 시/군/구
  latitude           Float?  @db.DoublePrecision // 위도
  longitude          Float?  @db.DoublePrecision // 경도

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)

  property Property @relation(fields: [property_id], references: [id], onDelete: Cascade)
}

// 규모 정보 (Scale)
model Scale {
  id                                String @id @default(cuid())
  property_id                       String @unique
  no_of_buildings                   Int    @default(0) // 건물 수 (원본 기본값 0 유지)
  upper_levels                      Int    @default(0) // 지상층 수 (원본 기본값 0 유지)
  basement_levels                   Int    @default(0) // 지하층 수
  gfa_sqm                           Float? @db.DoublePrecision // 연면적 (GFA) (m²)
  gfa_py                            Float? @db.DoublePrecision // 연면적 (GFA) (평)
  nfa_sqm                           Float? @db.DoublePrecision // 실면적 (NFA) (m²)
  nfa_py                            Float? @db.DoublePrecision // 실면적 (NFA) (평)
  site_area_sqm                     Float? @db.DoublePrecision // 대지면적 (m²)
  site_area_py                      Float? @db.DoublePrecision // 대지면적 (평)
  gross_leasable_area_sqm           Float? @db.DoublePrecision // 총 임대가능면적 (GLA) (m²)
  gross_leasable_area_py            Float? @db.DoublePrecision // 총 임대가능면적 (GLA) (평)
  net_leasable_area_sqm             Float? @db.DoublePrecision // 순 임대가능면적 (NLA) (m²)
  net_leasable_area_py              Float? @db.DoublePrecision // 순 임대가능면적 (NLA) (평)
  floor_area_ratio_existing         Float? @db.DoublePrecision // 용적률 (현황)
  floor_area_ratio_permitted        Float? @db.DoublePrecision // 용적률 (허용)
  building_coverage_ratio_existing  Float? @db.DoublePrecision // 건폐율 (현황)
  building_coverage_ratio_permitted Float? @db.DoublePrecision // 건폐율 (허용)
  floor_plate_sqm                   Float? @db.DoublePrecision // 기준층 면적 (m²)
  floor_plate_py                    Float? @db.DoublePrecision // 기준층 면적 (평)

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)

  property Property @relation(fields: [property_id], references: [id], onDelete: Cascade)
}

// 물류 창고 온도 유형별 정보
model Warehouse {
  id               String          @id @default(cuid())
  property_id      String
  temperature_type TemperatureType // 온도 유형 (상온, 저온, 정온)
  ratio            Float?          @db.DoublePrecision // 비율

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)
  property   Property @relation(fields: [property_id], references: [id], onDelete: Cascade)

  @@unique([property_id, temperature_type]) // 자산별 온도 유형의 유니크 키
}

// 창고 온도 유형 ENUM
enum TemperatureType {
  ROOM // 상온
  LOW // 저온
  CONSTANT // 정온
}

// 시설 정보 (Facility)
model Facility {
  id                    String  @id @default(cuid())
  property_id           String  @unique
  elevators_total       Int     @default(0) // 엘리베이터 총 수
  elevators_passenger   Int     @default(0) // 승객용 엘리베이터 수
  elevators_service     Int     @default(0) // 서비스용 엘리베이터 수
  elevators_freight     Int     @default(0) // 화물용 엘리베이터 수
  cps_existing          Int     @default(0) // 주차 대수 (현황)
  cps_required          Int     @default(0) // 주차 대수 (법정)
  free_cps_sqm          Float?  @db.DoublePrecision // 무료 주차 면적당 대수 (m²)
  free_cps_py           Float?  @db.DoublePrecision // 무료 주차 평당 대수 (평)
  paid_parking_fee      Int? // 유료 주차 요금
  roof_material         String? // 지붕 재료
  facade                String? // 외관
  mechanical_electrical Int? // 기계/전기
  lighting              String? // 조명
  fire_fighting         String? // 소방 시설

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)

  property Property @relation(fields: [property_id], references: [id], onDelete: Cascade)
}

// 접근성 정보 (Accessibility)
model Accessibility {
  id                      String  @id @default(cuid())
  property_id             String  @unique
  distance_to_ic          String? // IC까지 거리
  time_taken_to_city_hall String? // 시청까지 소요 시간
  time_taken_to_subway    String? // 지하철역까지 소요 시간
  nearby_facilities       String? // 주변 편의 시설
  nearby_attractions      String? // 주변 명소
  nearby_places           String? // 주변 장소

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)

  property Property @relation(fields: [property_id], references: [id], onDelete: Cascade)
}

// 수익성 정보 (Profitability)
model Profitability {
  id              String  @id @default(cuid())
  property_id     String  @unique
  grade           String? // 등급 (Grade)
  effective_ratio Float?  @db.DoublePrecision // 유효 비율 (Eff. Ratio)

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)

  property Property @relation(fields: [property_id], references: [id], onDelete: Cascade)
}

// 자산 변경 이력
model History {
  id          String      @id @default(cuid())
  property_id String
  year        String // 연도
  type        HistoryType // 이력 유형 (COMPLETION, RENOVATION)

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)

  property Property @relation(fields: [property_id], references: [id], onDelete: Cascade)
}

// 이력 유형 ENUM
enum HistoryType {
  COMPLETION // 준공
  RENOVATION // 리모델링
}

// ----------------------------------------------------------------------
// --- 층/호실 및 임대 정보 모델 (Floor, Unit & Lease) ---
// ----------------------------------------------------------------------

// 층 정보
model Floor {
  id                  String        @id @default(cuid())
  property_id         String
  type                LevelType? // 층 유형 (UPPER/BASEMENT)
  floor               Int? // 층 번호
  ceiling_height      Float?        @db.DoublePrecision // 천장 높이
  ceiling_height_unit String?       @default("m") // 천장 높이 단위
  floor_load          Float?        @db.DoublePrecision // 바닥 하중
  floor_load_unit     String?       @default("ton/㎡") // 바닥 하중 단위
  truck_berths        Int? // 트럭 베이 수
  use                 FloorUseType? // 층 사용 용도
  total_area_sqm      Float?        @db.DoublePrecision // 총 면적 (m²)
  total_area_py       Float?        @db.DoublePrecision // 총 면적 (평)

  gross_leasable_area_sqm Float? @db.DoublePrecision // 총 임대 가능 면적 (GLA) (m²)
  gross_leasable_area_py  Float? @db.DoublePrecision // 총 임대 가능 면적 (GLA) (평)

  net_leasable_area_sqm Float? @db.DoublePrecision // 순 임대 가능 면적 (NLA) (m²)
  net_leasable_area_py  Float? @db.DoublePrecision // 순 임대 가능 면적 (NLA) (평)

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)

  floorPartial FloorPartial[] // 층의 임차 호실 리스트
  property     Property       @relation(fields: [property_id], references: [id], onDelete: Cascade)

  @@unique([property_id, type, floor]) // 자산별, 층 유형별, 층 번호별 유니크 키
}

// 층 유형 ENUM
enum LevelType {
  UPPER // 지상층
  BASEMENT // 지하층
}

// 층 사용 용도 ENUM
enum FloorUseType {
  ROOM // 상온 창고
  OFFICE // 오피스
  LOW // 저온 창고
  CONSTANT // 정온 창고
}

// 임차 호실 상세 정보 (Floor Partial)
model FloorPartial {
  id                                     String       @id @default(cuid())
  floor_id                               String
  unit_number                            String? // 호실 번호
  tenant                                 String? // 임차인
  lease_area_sqm                         Float?       @db.DoublePrecision // 임대 면적 (m²)
  lease_area_py                          Float?       @db.DoublePrecision // 임대 면적 (평)
  tenant_equipment                       Boolean      @default(false) // 임차인 장비 유무
  tenant_use                             RoomUseType? // 호실 사용 용도
  lease_start_date                       DateTime?    @db.Timestamp(6) // 임대 시작일
  lease_end_date                         DateTime?    @db.Timestamp(6) // 임대 종료일
  deposit_krw                            Int? // 보증금 (KRW)
  monthly_rent_per_py                    Float?       @db.DoublePrecision // 월 임대료/평
  monthly_rent                           Int? // 월 임대료
  monthly_management_per_py              Float?       @db.DoublePrecision // 월 관리비/평
  monthly_management_fee                 Int? // 월 관리비
  increase_conditions_for_deposit        String? // 보증금 인상 조건
  increase_conditions_for_rent           String? // 임대료 인상 조건
  increase_conditions_for_management_fee String? // 관리비 인상 조건
  rent_free                              String? // 렌트 프리
  fit_out                                String? // 핏 아웃

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)

  floor Floor @relation(fields: [floor_id], references: [id], onDelete: Cascade)
}

// 호실 사용 용도 ENUM
enum RoomUseType {
  DRY // 건식 (상온)
  COLD // 냉동/냉장 (저온/정온)
  OFFICE // 오피스
  OTHERS // 기타
}

// ----------------------------------------------------------------------
// --- 파일 정보 모델 (File & Photo) ---
// ----------------------------------------------------------------------

// 자산 이미지 파일 정보
model PropertyImageFile {
  id                String  @id @default(cuid())
  property_id       String
  main              Boolean @default(false) // 대표 이미지 여부
  file_uuid         String? // 파일 고유 UUID
  file_name         String? // 파일명
  file_key          String? // 저장소 내 파일 키
  file_url          String? // 파일 URL
  file_content_type String? // 파일 Content-Type

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)
  property   Property @relation(fields: [property_id], references: [id], onDelete: Cascade)

  @@unique([property_id, file_uuid])
}

// 자산 브로슈어 파일 정보
model PropertyBrochureFile {
  id          String @id @default(cuid())
  property_id String

  file_uuid         String?
  file_name         String?
  file_key          String?
  file_url          String?
  file_content_type String?

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)
  property   Property @relation(fields: [property_id], references: [id], onDelete: Cascade)

  @@unique([property_id, file_uuid])
}

// 층별 평면도 파일 정보
model FloorPlanFile {
  id                String        @id @default(cuid())
  property_id       String
  type              FloorFlanType // 평면도 유형 (종단면, 횡단면, 지상층, 지하층) (원본은 nullable이 아님)
  floor             Int? // 층 번호 (UPPERSECTION, BASEMENTSECTION인 경우)
  file_uuid         String?
  file_name         String?
  file_key          String?
  file_url          String?
  file_content_type String?

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)

  property Property @relation(fields: [property_id], references: [id], onDelete: Cascade)

  @@unique([property_id, type, floor])
}

// 평면도 유형 ENUM
enum FloorFlanType {
  LOGITUDINALSECTION // 종단면도
  CROSSSECTION // 횡단면도
  UPPERSECTION // 층별 (지상)
  BASEMENTSECTION // 층별 (지하)
}

// ----------------------------------------------------------------------
// --- 거래 정보 모델 (Transaction, Sale, Lease) ---
// ----------------------------------------------------------------------

// 거래 기본 정보 (매매/임대 공통)
model Transaction {
  id             String          @id @default(cuid())
  property_id    String // 자산 ID (Property와의 1:N 관계)
  type           TransactionType // 거래 유형 (SALE/LEASE)
  year           String // 거래 연도
  quarter        String // 거래 분기
  execution_date DateTime        @db.Timestamp(6) // 거래일

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)

  property Property @relation(fields: [property_id], references: [id], onDelete: Cascade)

  // Sale/Lease와 1:1 관계
  sale  Sale?
  lease Lease?
}

// 거래 유형 ENUM
enum TransactionType {
  SALE // 매매
  LEASE // 임대
}

// 매매 상세 정보
model Sale {
  id                String   @id @default(cuid())
  transaction_id    String?  @unique // Transaction과의 1:1 관계를 위한 유니크 키
  sale_type         SaleType // 거래 유형 (ENBLOC/PARTIAL)
  gfa_sqm           Float?   @db.DoublePrecision // 연면적 (m²)
  nfa_sqm           Float?   @db.DoublePrecision // 실면적 (m²)
  price_krw         Int? // 매매가 (KRW)
  price_per_gfa     Int? // GFA당 가격
  price_per_nfa     Int? // NFA당 가격
  est_cap_rate      Float?   @db.DoublePrecision // 예상 자본환원율 (Cap Rate)
  est_discount_rate Float?   @db.DoublePrecision // 예상 할인율
  buyer             String? // 매수자
  seller            String? // 매도자
  remarks           String? // 비고

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)

  Transaction Transaction? @relation(fields: [transaction_id], references: [id])
}

// 매매 유형 ENUM
enum SaleType {
  ENBLOC // 통매각
  PARTIAL // 부분 매각
}

// 임대 상세 정보
model Lease {
  id                               String        @id @default(cuid())
  transaction_id                   String?       @unique // Transaction과의 1:1 관계를 위한 유니크 키
  lease_type                       LeaseType? // 임대 유형 (ASKING/ACTUAL)
  floor                            String? // 층 정보 (문자열)
  unit                             String? // 호실 정보 (문자열)
  tenant                           String? // 임차인
  lease_start_date                 DateTime?     @db.Timestamp(6) // 임대 시작일
  lease_end_date                   DateTime?     @db.Timestamp(6) // 임대 종료일
  gfa_sqm                          Float?        @db.DoublePrecision // 총 연면적 (m²)
  gfa_py                           Float?        @db.DoublePrecision // 총 연면적 (평)
  nfa_sqm                          Float?        @db.DoublePrecision // 순 연면적 (m²)
  nfa_py                           Float?        @db.DoublePrecision // 순 연면적 (평)
  eff_ratio                        Float?        @db.DoublePrecision // 유효 비율
  monthly_rent                     Int? // 월 임대료
  monthly_camf                     Int? // 월 관리비
  deposit                          Int? // 보증금
  rent_monthly_py                  Int? // 평당 월 임대료
  camf_monthly_py                  Int? // 평당 월 관리비
  deposit_py                       Int? // 평당 보증금
  iod                              Float?        @db.DoublePrecision // In-place Occupancy Date (IOD)
  gdm                              Float?        @db.DoublePrecision // Gross Discounted Margin (GDM)
  noc                              Float?        @db.DoublePrecision // Net Occupancy Cost (NOC)
  lease_term_year                  Int? // 임대 기간 (년)
  rent_free_type                   RentFreeType? // 렌트프리 유형
  rent_free_month                  Int? // 렌트프리 기간 (월)
  effective_noc                    Float?        @db.DoublePrecision // 유효 NOC
  fit_out                          Int? // Fit-out 지원액
  ti_amount_krw                    Float?        @db.DoublePrecision // TI (Tenant Improvement) 금액 (KRW)
  ti_amount_nfa_py                 Float?        @db.DoublePrecision // 평당 TI 금액 (NFA 기준)
  total_free_rent_period_month     Int? // 총 렌트프리 기간 (월)
  total_occupying_period_year      Float?        @db.DoublePrecision // 총 점유 기간 (년)
  total_free_rent_occupying_year   Float?        @db.DoublePrecision // 렌트프리 포함 총 점유 기간 (년)
  monthly_cash_support_gfa         Float?        @db.DoublePrecision // GFA당 월별 현금 지원액
  all_in_effective_rent_monthly_py Float?        @db.DoublePrecision // 올인 유효 임대료/월/평
  all_in_noc                       Float?        @db.DoublePrecision // 올인 NOC

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)

  Transaction Transaction? @relation(fields: [transaction_id], references: [id])
}

// 임대 유형 ENUM
enum LeaseType {
  ASKING // 요청/호가
  ACTUAL // 실제 거래
}

// 렌트프리 유형 ENUM
enum RentFreeType {
  PerYear // 연간
  PerTerm // 계약 기간 전체
}
